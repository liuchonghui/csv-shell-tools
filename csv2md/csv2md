#!/bin/bash
##############################################################################
# 脚本名称：csv2md
# 脚本功能：
#   1. 将标准CSV文件转换为结构化的Markdown表格；
#   2. 保留CSV的首行表头作为Markdown表格标题行；
#   3. 自动适配CSV列数，生成对齐的Markdown表格分隔线；
#   4. 兼容带空格/特殊字符的CSV字段，适配绝对/相对路径输入。
# 使用方法：
#   ./csv2md <目标CSV文件路径>
#   示例：
#     ./csv2md test.csv          # 相对路径
#     ./csv2md /tmp/data.csv     # 绝对路径
# 输出说明：
#   - 输出文件与输入CSV同目录，命名规则：原文件名 + .md（如test.csv → test.md）；
#   - 输出文件为标准Markdown表格格式，保留CSV所有行/列信息。
##############################################################################

# 全局变量配置
TMP_FILE=$(mktemp /tmp/csv2md.XXXXXX)

# 检查必要参数是否传入
if [ $# -eq 0 ]; then
    echo "Error: Missing required parameter. Usage: $0 <target_csv_file>"
    exit 1
fi

# 提取最后一个参数作为目标CSV文件路径
INPUT_FILE="${@: -1}"

# 检查目标文件是否存在且为普通文件
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Target CSV file $INPUT_FILE does not exist or is not a regular file."
    exit 1
fi

# 检查临时文件创建状态
if [ ! -w "$TMP_FILE" ]; then
    echo "Error: Failed to create temporary file."
    exit 1
fi

# 第一步：处理CSV文件，转换为Markdown表格格式
awk -F ',' '
    # 处理首行（表头）
    NR == 1 {
        # 拼接表头行（| 字段1 | 字段2 | ... |）
        header = "| "
        for (i=1; i<=NF; i++) {
            # 清理字段首尾空格
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $i)
            header = header $i " | "
        }
        # 去除末尾多余空格，输出表头行
        sub(/ \| $/, " |", header)
        print header > "'"$TMP_FILE"'"
        
        # 生成分隔线行（| --- | --- | ... |）
        separator = "| "
        for (i=1; i<=NF; i++) {
            separator = separator "--- | "
        }
        sub(/ \| $/, " |", separator)
        print separator > "'"$TMP_FILE"'"
        next
    }
    
    # 处理数据行
    {
        # 拼接数据行（| 字段1 | 字段2 | ... |）
        row = "| "
        for (i=1; i<=NF; i++) {
            # 清理字段首尾空格
            gsub(/^[[:space:]]+|[[:space:]]+$/, "", $i)
            # 处理空值（null替换为空字符串）
            if ($i == "null") $i = ""
            row = row $i " | "
        }
        # 去除末尾多余空格，输出数据行
        sub(/ \| $/, " |", row)
        print row > "'"$TMP_FILE"'"
    }
' "$INPUT_FILE"

# 检查转换结果是否为空
if [ ! -s "$TMP_FILE" ]; then
    echo "Warning: No valid content converted from $INPUT_FILE."
    rm -f "$TMP_FILE"
    exit 0
fi

# 第二步：构造输出文件名（原文件名 + .md）
INPUT_DIR=$(dirname "$INPUT_FILE")
INPUT_FILENAME=$(basename "$INPUT_FILE")
# 移除原CSV后缀（如test.csv → test），避免出现test.csv.md
BASE_NAME="${INPUT_FILENAME%.csv}"
OUTPUT_FILE="${INPUT_DIR}/${BASE_NAME}.md"

# 第三步：将临时文件内容写入最终输出文件
cp "$TMP_FILE" "$OUTPUT_FILE"

# 清理临时文件
rm -f "$TMP_FILE"

# 输出完成信息
TOTAL_ROWS=$(wc -l < "$OUTPUT_FILE")
# Markdown表格行数 = 表头1行 + 分隔线1行 + 数据行N行
DATA_ROWS=$(( TOTAL_ROWS - 2 ))
echo "Completed. Total data rows in Markdown table: $DATA_ROWS"
echo "Result file: $(realpath "$OUTPUT_FILE")"